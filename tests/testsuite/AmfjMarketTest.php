<?php

/* This file is part of Jeedom.
 *
 * Jeedom is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Jeedom is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Jeedom. If not, see <http://www.gnu.org/licenses/>.
 */

use PHPUnit\Framework\TestCase;

require_once('core/class/AmfjMarket.class.php');
require_once('core/class/AmfjDataStorage.class.php');
require_once('../../core/php/core.inc.php');

class AmfjMarketTest extends TestCase
{
    /**
     * @var AmfjMarket
     */
    private $market;

    private $dataStorage;

    public function setUp()
    {
        if (file_exists('.github-token')) {
            $token = str_replace("\n", "", file_get_contents('.github-token'));
            config::addKeyToCore('github::token', $token);
        }
        update::$byLogicalIdResult = false;
        DB::init(true);
        $source = [];
        $source['type'] = 'github';
        $source['name'] = 'NextDom';
        $source['data'] = 'NextDom';
        $this->market = new AmfjMarket($source);
        $this->dataStorage = new AmfjDataStorage('amfj');
        $this->dataStorage->createDataTable();
        mkdir('cache');
    }

    public function tearDown()
    {
        $filesList = scandir('cache');
        foreach ($filesList as $file) {
            if ($file != '.' && $file != '..') {
                unlink('cache/' . $file);
            }
        }
        rmdir('cache');
        $this->dataStorage->dropDataTable();
    }

    private function getItemFromList($items, $itemName)
    {
        foreach ($items as $item) {
            if ($item->getGitName() == $itemName) {
                return $item;
            }
        }
        return null;
    }

    public function testRefreshDisconnected() {
        AmfjDownloadManager::init(false);
        try {
            $this->market->refresh();
            $this->fail('Exception non levÃ©e avec un mauvais utilisateur');
        } catch (Exception $e) {
            $this->assertEquals('Pas de connection internet', $e->getMessage());
        }
    }

    public function testRefreshGitFirstTime()
    {
        $this->dataStorage->storeRawData('repo_ignore_jeedom', '["to_remove"]');
        $this->market->refresh();
        $ignoreList = $this->dataStorage->getJsonData('repo_ignore_NextDom');
        $this->assertTrue(in_array('AlternativeMarket-Lists', $ignoreList));
        $this->assertFalse(in_array('to_remove', $ignoreList));
        $lastUpdate = $this->dataStorage->getJsonData('repo_last_update_NextDom');
        $this->assertTrue(is_numeric($lastUpdate));
        $globalRepo = $this->dataStorage->getJsonData('repo_data_NextDom');
        $this->assertTrue(is_array($globalRepo));
        $amfjRepo = $this->dataStorage->getJsonData('repo_data_NextDom_plugin-AlternativeMarketForJeedom');
        $optimizeRepo = $this->dataStorage->getJsonData('repo_data_NextDom_plugin-Optimize');
        $this->assertTrue(is_array($amfjRepo));
        $this->assertArrayHasKey('fullName', $optimizeRepo);
    }

    public function testRefreshGitWithGitData()
    {
        $repoData = '[{"id":132484483,"name":"AlternativeMarket-Lists","full_name":"NextDom/AlternativeMarket-Lists","owner":{ "login":"NextDom","id":36200380,"avatar_url":"https://avatars2.githubusercontent.com/u/36200380?v=4","gravatar_id":"","url":"https://api.github.com/users/NextDom","html_url":"https://github.com/NextDom","followers_url":"https://api.github.com/users/NextDom/followers","following_url":"https://api.github.com/users/NextDom/following{/other_user}","gists_url":"https://api.github.com/users/NextDom/gists{/gist_id}","starred_url":"https://api.github.com/users/NextDom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/NextDom/subscriptions","organizations_url":"https://api.github.com/users/NextDom/orgs","repos_url":"https://api.github.com/users/NextDom/repos","events_url":"https://api.github.com/users/NextDom/events{/privacy}","received_events_url":"https://api.github.com/users/NextDom/received_events","type":"Organization","site_admin":false },"private":false,"html_url":"https://github.com/NextDom/AlternativeMarket-Lists","description":null,"fork":false,"url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists","forks_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/forks","keys_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/keys{/key_id}","collaborators_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/teams","hooks_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/hooks","issue_events_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/issues/events{/number}","events_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/events","assignees_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/assignees{/user}","branches_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/branches{/branch}","tags_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/tags","blobs_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/git/refs{/sha}","trees_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/git/trees{/sha}","statuses_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/statuses/{sha}","languages_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/languages","stargazers_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/stargazers","contributors_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/contributors","subscribers_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/subscribers","subscription_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/subscription","commits_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/commits{/sha}","git_commits_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/git/commits{/sha}","comments_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/comments{/number}","issue_comment_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/issues/comments{/number}","contents_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/contents/{+path}","compare_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/compare/{base}...{head}","merges_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/merges","archive_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/downloads","issues_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/issues{/number}","pulls_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/pulls{/number}","milestones_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/milestones{/number}","notifications_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/labels{/name}","releases_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/releases{/id}","deployments_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/deployments","created_at":"2018-05-07T16:01:02Z","updated_at":"2018-05-11T16:42:20Z","pushed_at":"2018-05-11T16:42:18Z","git_url":"git://github.com/NextDom/AlternativeMarket-Lists.git","ssh_url":"git@github.com:NextDom/AlternativeMarket-Lists.git","clone_url":"https://github.com/NextDom/AlternativeMarket-Lists.git","svn_url":"https://github.com/NextDom/AlternativeMarket-Lists","homepage":null,"size":86,"stargazers_count":0,"watchers_count":0,"language":"PHP","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"forks_count":0,"mirror_url":null,"archived":false,"open_issues_count":0,"license":{ "key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0" },"forks":0,"open_issues":0,"watchers":0,"default_branch":"master" }, { "id":74405272,"name":"plugin-MiFlora","full_name":"NextDom/plugin-MiFlora","owner":{ "login":"NextDom","id":36200380,"avatar_url":"https://avatars2.githubusercontent.com/u/36200380?v=4","gravatar_id":"","url":"https://api.github.com/users/NextDom","html_url":"https://github.com/NextDom","followers_url":"https://api.github.com/users/NextDom/followers","following_url":"https://api.github.com/users/NextDom/following{/other_user}","gists_url":"https://api.github.com/users/NextDom/gists{/gist_id}","starred_url":"https://api.github.com/users/NextDom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/NextDom/subscriptions","organizations_url":"https://api.github.com/users/NextDom/orgs","repos_url":"https://api.github.com/users/NextDom/repos","events_url":"https://api.github.com/users/NextDom/events{/privacy}","received_events_url":"https://api.github.com/users/NextDom/received_events","type":"Organization","site_admin":false },"private":false,"html_url":"https://github.com/NextDom/plugin-MiFlora","description":"plugin Jeedom pour gerer les Mi Flora","fork":false,"url":"https://api.github.com/repos/NextDom/plugin-MiFlora","forks_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/forks","keys_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/keys{/key_id}","collaborators_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/teams","hooks_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/hooks","issue_events_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/issues/events{/number}","events_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/events","assignees_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/assignees{/user}","branches_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/branches{/branch}","tags_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/tags","blobs_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/git/refs{/sha}","trees_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/git/trees{/sha}","statuses_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/statuses/{sha}","languages_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/languages","stargazers_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/stargazers","contributors_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/contributors","subscribers_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/subscribers","subscription_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/subscription","commits_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/commits{/sha}","git_commits_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/git/commits{/sha}","comments_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/comments{/number}","issue_comment_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/issues/comments{/number}","contents_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/contents/{+path}","compare_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/compare/{base}...{head}","merges_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/merges","archive_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/downloads","issues_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/issues{/number}","pulls_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/pulls{/number}","milestones_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/milestones{/number}","notifications_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/labels{/name}","releases_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/releases{/id}","deployments_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/deployments","created_at":"2016-11-21T20:59:11Z","updated_at":"2018-05-07T19:26:18Z","pushed_at":"2018-05-12T08:12:20Z","git_url":"git://github.com/NextDom/plugin-MiFlora.git","ssh_url":"git@github.com:NextDom/plugin-MiFlora.git","clone_url":"https://github.com/NextDom/plugin-MiFlora.git","svn_url":"https://github.com/NextDom/plugin-MiFlora","homepage":null,"size":2699,"stargazers_count":2,"watchers_count":2,"language":"PHP","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":true,"forks_count":13,"mirror_url":null,"archived":false,"open_issues_count":7,"license":{ "key":"gpl-2.0","name":"GNU General Public License v2.0","spdx_id":"GPL-2.0","url":"https://api.github.com/licenses/gpl-2.0" },"forks":13,"open_issues":7,"watchers":2,"default_branch":"master" }, { "id":123343068,"name":"plugin-Optimize","full_name":"NextDom/plugin-Optimize","owner":{ "login":"NextDom","id":36200380,"avatar_url":"https://avatars2.githubusercontent.com/u/36200380?v=4","gravatar_id":"","url":"https://api.github.com/users/NextDom","html_url":"https://github.com/NextDom","followers_url":"https://api.github.com/users/NextDom/followers","following_url":"https://api.github.com/users/NextDom/following{/other_user}","gists_url":"https://api.github.com/users/NextDom/gists{/gist_id}","starred_url":"https://api.github.com/users/NextDom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/NextDom/subscriptions","organizations_url":"https://api.github.com/users/NextDom/orgs","repos_url":"https://api.github.com/users/NextDom/repos","events_url":"https://api.github.com/users/NextDom/events{/privacy}","received_events_url":"https://api.github.com/users/NextDom/received_events","type":"Organization","site_admin":false },"private":false,"html_url":"https://github.com/NextDom/plugin-Optimize","description":"Plugin pour Jeedom d\'optimisation des performances","fork":false,"url":"https://api.github.com/repos/NextDom/plugin-Optimize","forks_url":"https://api.github.com/repos/NextDom/plugin-Optimize/forks","keys_url":"https://api.github.com/repos/NextDom/plugin-Optimize/keys{/key_id}","collaborators_url":"https://api.github.com/repos/NextDom/plugin-Optimize/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/NextDom/plugin-Optimize/teams","hooks_url":"https://api.github.com/repos/NextDom/plugin-Optimize/hooks","issue_events_url":"https://api.github.com/repos/NextDom/plugin-Optimize/issues/events{/number}","events_url":"https://api.github.com/repos/NextDom/plugin-Optimize/events","assignees_url":"https://api.github.com/repos/NextDom/plugin-Optimize/assignees{/user}","branches_url":"https://api.github.com/repos/NextDom/plugin-Optimize/branches{/branch}","tags_url":"https://api.github.com/repos/NextDom/plugin-Optimize/tags","blobs_url":"https://api.github.com/repos/NextDom/plugin-Optimize/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/NextDom/plugin-Optimize/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/NextDom/plugin-Optimize/git/refs{/sha}","trees_url":"https://api.github.com/repos/NextDom/plugin-Optimize/git/trees{/sha}","statuses_url":"https://api.github.com/repos/NextDom/plugin-Optimize/statuses/{sha}","languages_url":"https://api.github.com/repos/NextDom/plugin-Optimize/languages","stargazers_url":"https://api.github.com/repos/NextDom/plugin-Optimize/stargazers","contributors_url":"https://api.github.com/repos/NextDom/plugin-Optimize/contributors","subscribers_url":"https://api.github.com/repos/NextDom/plugin-Optimize/subscribers","subscription_url":"https://api.github.com/repos/NextDom/plugin-Optimize/subscription","commits_url":"https://api.github.com/repos/NextDom/plugin-Optimize/commits{/sha}","git_commits_url":"https://api.github.com/repos/NextDom/plugin-Optimize/git/commits{/sha}","comments_url":"https://api.github.com/repos/NextDom/plugin-Optimize/comments{/number}","issue_comment_url":"https://api.github.com/repos/NextDom/plugin-Optimize/issues/comments{/number}","contents_url":"https://api.github.com/repos/NextDom/plugin-Optimize/contents/{+path}","compare_url":"https://api.github.com/repos/NextDom/plugin-Optimize/compare/{base}...{head}","merges_url":"https://api.github.com/repos/NextDom/plugin-Optimize/merges","archive_url":"https://api.github.com/repos/NextDom/plugin-Optimize/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/NextDom/plugin-Optimize/downloads","issues_url":"https://api.github.com/repos/NextDom/plugin-Optimize/issues{/number}","pulls_url":"https://api.github.com/repos/NextDom/plugin-Optimize/pulls{/number}","milestones_url":"https://api.github.com/repos/NextDom/plugin-Optimize/milestones{/number}","notifications_url":"https://api.github.com/repos/NextDom/plugin-Optimize/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/NextDom/plugin-Optimize/labels{/name}","releases_url":"https://api.github.com/repos/NextDom/plugin-Optimize/releases{/id}","deployments_url":"https://api.github.com/repos/NextDom/plugin-Optimize/deployments","created_at":"2018-02-28T21:11:55Z","updated_at":"2018-05-02T14:12:16Z","pushed_at":"2018-04-20T14:29:40Z","git_url":"git://github.com/NextDom/plugin-Optimize.git","ssh_url":"git@github.com:NextDom/plugin-Optimize.git","clone_url":"https://github.com/NextDom/plugin-Optimize.git","svn_url":"https://github.com/NextDom/plugin-Optimize","homepage":null,"size":2821,"stargazers_count":0,"watchers_count":0,"language":"PHP","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":true,"forks_count":3,"mirror_url":null,"archived":false,"open_issues_count":2,"license":{ "key":"gpl-2.0","name":"GNU General Public License v2.0","spdx_id":"GPL-2.0","url":"https://api.github.com/licenses/gpl-2.0" },"forks":3,"open_issues":2,"watchers":0,"default_branch":"master" }, { "id":124239286,"name":"extra-tools","full_name":"NextDom/extra-tools","owner":{ "login":"NextDom","id":36200380,"avatar_url":"https://avatars2.githubusercontent.com/u/36200380?v=4","gravatar_id":"","url":"https://api.github.com/users/NextDom","html_url":"https://github.com/NextDom","followers_url":"https://api.github.com/users/NextDom/followers","following_url":"https://api.github.com/users/NextDom/following{/other_user}","gists_url":"https://api.github.com/users/NextDom/gists{/gist_id}","starred_url":"https://api.github.com/users/NextDom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/NextDom/subscriptions","organizations_url":"https://api.github.com/users/NextDom/orgs","repos_url":"https://api.github.com/users/NextDom/repos","events_url":"https://api.github.com/users/NextDom/events{/privacy}","received_events_url":"https://api.github.com/users/NextDom/received_events","type":"Organization","site_admin":false },"private":false,"html_url":"https://github.com/NextDom/extra-tools","description":"Outils permettant la gÃ©nÃ©ration d\'un squellette de plugin Jeedom Ã  partir du plugin-Template","fork":false,"url":"https://api.github.com/repos/NextDom/extra-tools","forks_url":"https://api.github.com/repos/NextDom/extra-tools/forks","keys_url":"https://api.github.com/repos/NextDom/extra-tools/keys{/key_id}","collaborators_url":"https://api.github.com/repos/NextDom/extra-tools/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/NextDom/extra-tools/teams","hooks_url":"https://api.github.com/repos/NextDom/extra-tools/hooks","issue_events_url":"https://api.github.com/repos/NextDom/extra-tools/issues/events{/number}","events_url":"https://api.github.com/repos/NextDom/extra-tools/events","assignees_url":"https://api.github.com/repos/NextDom/extra-tools/assignees{/user}","branches_url":"https://api.github.com/repos/NextDom/extra-tools/branches{/branch}","tags_url":"https://api.github.com/repos/NextDom/extra-tools/tags","blobs_url":"https://api.github.com/repos/NextDom/extra-tools/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/NextDom/extra-tools/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/NextDom/extra-tools/git/refs{/sha}","trees_url":"https://api.github.com/repos/NextDom/extra-tools/git/trees{/sha}","statuses_url":"https://api.github.com/repos/NextDom/extra-tools/statuses/{sha}","languages_url":"https://api.github.com/repos/NextDom/extra-tools/languages","stargazers_url":"https://api.github.com/repos/NextDom/extra-tools/stargazers","contributors_url":"https://api.github.com/repos/NextDom/extra-tools/contributors","subscribers_url":"https://api.github.com/repos/NextDom/extra-tools/subscribers","subscription_url":"https://api.github.com/repos/NextDom/extra-tools/subscription","commits_url":"https://api.github.com/repos/NextDom/extra-tools/commits{/sha}","git_commits_url":"https://api.github.com/repos/NextDom/extra-tools/git/commits{/sha}","comments_url":"https://api.github.com/repos/NextDom/extra-tools/comments{/number}","issue_comment_url":"https://api.github.com/repos/NextDom/extra-tools/issues/comments{/number}","contents_url":"https://api.github.com/repos/NextDom/extra-tools/contents/{+path}","compare_url":"https://api.github.com/repos/NextDom/extra-tools/compare/{base}...{head}","merges_url":"https://api.github.com/repos/NextDom/extra-tools/merges","archive_url":"https://api.github.com/repos/NextDom/extra-tools/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/NextDom/extra-tools/downloads","issues_url":"https://api.github.com/repos/NextDom/extra-tools/issues{/number}","pulls_url":"https://api.github.com/repos/NextDom/extra-tools/pulls{/number}","milestones_url":"https://api.github.com/repos/NextDom/extra-tools/milestones{/number}","notifications_url":"https://api.github.com/repos/NextDom/extra-tools/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/NextDom/extra-tools/labels{/name}","releases_url":"https://api.github.com/repos/NextDom/extra-tools/releases{/id}","deployments_url":"https://api.github.com/repos/NextDom/extra-tools/deployments","created_at":"2018-03-07T13:22:49Z","updated_at":"2018-04-09T20:17:29Z","pushed_at":"2018-04-09T20:17:27Z","git_url":"git://github.com/NextDom/extra-tools.git","ssh_url":"git@github.com:NextDom/extra-tools.git","clone_url":"https://github.com/NextDom/extra-tools.git","svn_url":"https://github.com/NextDom/extra-tools","homepage":null,"size":119,"stargazers_count":0,"watchers_count":0,"language":"Python","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"forks_count":1,"mirror_url":null,"archived":false,"open_issues_count":5,"license":null,"forks":1,"open_issues":5,"watchers":0,"default_branch":"develop" }]';
        $updateTime = time();
        $this->dataStorage->storeRawData('repo_ignore_NextDom', '["plugin-Optimize"]');
        $this->dataStorage->storeRawData('repo_last_update_NextDom', $updateTime);
        $this->dataStorage->storeRawData('repo_data_NextDom', $repoData);
        $this->market->refresh();

        $lastUpdate = $this->dataStorage->getRawData('repo_last_update_NextDom');
        $this->assertEquals($lastUpdate, $updateTime);
        $repoResults = $this->dataStorage->getRawData('repo_data_NextDom');
        $this->assertEquals($repoResults, $repoData);
        $pluginOptimize = $this->dataStorage->getRawData('repo_data_NextDom_plugin-Optimize');
        $this->assertNull($pluginOptimize);
        $pluginMiFlora = $this->dataStorage->getJsonData('repo_data_NextDom_plugin-MiFlora');
        $this->assertNotNull($pluginMiFlora);
        $this->assertEquals('MiFlora', $pluginMiFlora['name']);
        $this->assertFileExists('cache/NextDom_plugin-MiFlora.png');
        $ignoreList = $this->dataStorage->getJsonData('repo_ignore_NextDom');
        $this->assertTrue(in_array('plugin-Optimize', $ignoreList));
        $this->assertTrue(in_array('AlternativeMarket-Lists', $ignoreList));
        $this->assertFalse(in_array('plugin-MiFlora', $ignoreList));
    }

    public function testRefreshJsonFirstTime()
    {
        $source = [];
        $source['type'] = 'json';
        $source['name'] = 'NextDom';
        $source['data'] = 'https://raw.githubusercontent.com/NextDom/AlternativeMarket-Lists/master/results/nextdom-stable.json';
        $this->market = new AmfjMarket($source);
        $this->market->refresh();
        $lastUpdate = $this->dataStorage->getJsonData('repo_last_update_NextDom');
        $this->assertTrue(is_numeric($lastUpdate));
        $globalRepo = $this->dataStorage->getJsonData('repo_data_NextDom');
        $this->assertTrue(is_array($globalRepo));
        $amfjRepo = $this->dataStorage->getJsonData('repo_data_NextDom_plugin-AlternativeMarketForJeedom');
        $miFlora = $this->dataStorage->getJsonData('repo_data_NextDom_plugin-MiFlora');
        $this->assertTrue(is_array($amfjRepo));
        $this->assertArrayHasKey('fullName', $miFlora);
    }

    public function testRefreshJsonWithData() {
        $sourceData = '{"version":1526361553,"plugins":[{"defaultBranch":"master","gitId":"NextDom","repository":"plugin-AlternativeMarketForJeedom","id":"AlternativeMarketForJeedom","name":"AlternativeMarketForJeedom","licence":"GPL","description":"Market alternatif pour la solution domotique Jeedom","require":"3.0","category":"programming","documentation":"https:\/\/jeedom.github.io\/plugin-AlternativeMarketForJeedom\/#language#\/","changelog":"https:\/\/jeedom.github.io\/plugin-AlternativeMarketForJeedom\/#language#\/changelog","author":"Sylvain DANGIN","branches":[{"name":"develop","hash":"8336e911323f6b7fb665856b92b4c4c0c8e2661e"},{"name":"feature\/MarketForAll","hash":"c08d6c6cf3aef81f5d1fe74913985d5163188382"},{"name":"feature\/NamespaceComposer","hash":"958b99be02285d88af2edffeb0d0d5857c526a47"},{"name":"master","hash":"e604e4fea235c9879938afbdc9102e94b7ed5f5c"},{"name":"release\/0.4","hash":"43d8f27f0c73163d6bef74fd96b1a3c91109cff6"}]},{"defaultBranch":"master","gitId":"NextDom","repository":"plugin-MiFlora","id":"MiFlora","name":"MiFlora","licence":"GPL2.0","description":"Ce plugin permet de g\u00e8rer les Xiaomi plants ou Mi Flora. Il n\u00e9c\u00e9ssite une connection bluetooth vers les mi flora.","require":"2.4","category":"nature","documentation":"https:\/\/rjullien.github.io\/plugin-MiFlora\/#language#","changelog":"https:\/\/rjullien.github.io\/plugin-MiFlora\/#language#\/#tocAnchor-1-7","author":"Rene Jullien","branches":[{"name":"Beta","hash":"5dc402fc1b5dd51fafc5331a72b117d1d88326a9"},{"name":"Develop","hash":"b8f994039e1ae668feab546ec17d5f168904b52c"},{"name":"master","hash":"95e55487b6a970ffd3dc9a4abf3239dd233e4872"},{"name":"revert-58-fbell","hash":"800a7b550732d335fb57f2268557ae7dd6ca1e89"},{"name":"stable","hash":"e5e8a4827d707778cba33e21b2b6ebb10d82560d"}]},{"defaultBranch":"master","gitId":"NextDom","repository":"plugin-AndroidRemoteControl","id":"AndroidRemoteControl","name":"AndroidRemoteControl","licence":"AGPL","description":"Plugin pour piloter les Android TV et autres \u00e9quipements Android","require":"3.0","category":"multimedia","documentation":"https:\/\/NextDom.github.io\/plugin-AndroidRemoteControl\/","changelog":"https:\/\/NextDom.github.io\/plugin-AndroidRemoteControl\/fr_FR\/changelog.html","author":"NextDom [Byackee, Slobberbone]","branches":[{"name":"develop","hash":"e960c3dd8da3eea033a32a12fa77a1205fe0e95f"},{"name":"master","hash":"7bbbff6ce1b2775b4472d8e0de1893fb77a6cf18"}]}]}';
        $source = [];
        $source['type'] = 'json';
        $source['name'] = 'NextDom';
        $source['data'] = 'NextDom';
        $this->market = new AmfjMarket($source);
        $updateTime = time();
        $this->dataStorage->storeRawData('repo_ignore_NextDom', '["plugin-AndroidRemoteControl"]');
        $this->dataStorage->storeRawData('repo_last_update_NextDom', $updateTime);
        $this->dataStorage->storeRawData('repo_data_NextDom', $sourceData);
        $this->market->refresh();

        $lastUpdate = $this->dataStorage->getRawData('repo_last_update_NextDom');
        $this->assertEquals($lastUpdate, $updateTime);
        $repoResults = $this->dataStorage->getRawData('repo_data_NextDom');
        $this->assertEquals($repoResults, $sourceData);
        $ignoreList = $this->dataStorage->getJsonData('repo_ignore_NextDom');
        $this->assertTrue(in_array('plugin-AndroidRemoteControl', $ignoreList));
    }

    public function testGetItemsFromGitHub()
    {
        $repoData = '[{"id":132484483,"name":"AlternativeMarket-Lists","full_name":"NextDom/AlternativeMarket-Lists","owner":{ "login":"NextDom","id":36200380,"avatar_url":"https://avatars2.githubusercontent.com/u/36200380?v=4","gravatar_id":"","url":"https://api.github.com/users/NextDom","html_url":"https://github.com/NextDom","followers_url":"https://api.github.com/users/NextDom/followers","following_url":"https://api.github.com/users/NextDom/following{/other_user}","gists_url":"https://api.github.com/users/NextDom/gists{/gist_id}","starred_url":"https://api.github.com/users/NextDom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/NextDom/subscriptions","organizations_url":"https://api.github.com/users/NextDom/orgs","repos_url":"https://api.github.com/users/NextDom/repos","events_url":"https://api.github.com/users/NextDom/events{/privacy}","received_events_url":"https://api.github.com/users/NextDom/received_events","type":"Organization","site_admin":false },"private":false,"html_url":"https://github.com/NextDom/AlternativeMarket-Lists","description":null,"fork":false,"url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists","forks_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/forks","keys_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/keys{/key_id}","collaborators_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/teams","hooks_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/hooks","issue_events_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/issues/events{/number}","events_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/events","assignees_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/assignees{/user}","branches_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/branches{/branch}","tags_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/tags","blobs_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/git/refs{/sha}","trees_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/git/trees{/sha}","statuses_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/statuses/{sha}","languages_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/languages","stargazers_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/stargazers","contributors_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/contributors","subscribers_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/subscribers","subscription_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/subscription","commits_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/commits{/sha}","git_commits_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/git/commits{/sha}","comments_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/comments{/number}","issue_comment_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/issues/comments{/number}","contents_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/contents/{+path}","compare_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/compare/{base}...{head}","merges_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/merges","archive_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/downloads","issues_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/issues{/number}","pulls_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/pulls{/number}","milestones_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/milestones{/number}","notifications_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/labels{/name}","releases_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/releases{/id}","deployments_url":"https://api.github.com/repos/NextDom/AlternativeMarket-Lists/deployments","created_at":"2018-05-07T16:01:02Z","updated_at":"2018-05-11T16:42:20Z","pushed_at":"2018-05-11T16:42:18Z","git_url":"git://github.com/NextDom/AlternativeMarket-Lists.git","ssh_url":"git@github.com:NextDom/AlternativeMarket-Lists.git","clone_url":"https://github.com/NextDom/AlternativeMarket-Lists.git","svn_url":"https://github.com/NextDom/AlternativeMarket-Lists","homepage":null,"size":86,"stargazers_count":0,"watchers_count":0,"language":"PHP","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"forks_count":0,"mirror_url":null,"archived":false,"open_issues_count":0,"license":{ "key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0" },"forks":0,"open_issues":0,"watchers":0,"default_branch":"master" }, { "id":74405272,"name":"plugin-MiFlora","full_name":"NextDom/plugin-MiFlora","owner":{ "login":"NextDom","id":36200380,"avatar_url":"https://avatars2.githubusercontent.com/u/36200380?v=4","gravatar_id":"","url":"https://api.github.com/users/NextDom","html_url":"https://github.com/NextDom","followers_url":"https://api.github.com/users/NextDom/followers","following_url":"https://api.github.com/users/NextDom/following{/other_user}","gists_url":"https://api.github.com/users/NextDom/gists{/gist_id}","starred_url":"https://api.github.com/users/NextDom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/NextDom/subscriptions","organizations_url":"https://api.github.com/users/NextDom/orgs","repos_url":"https://api.github.com/users/NextDom/repos","events_url":"https://api.github.com/users/NextDom/events{/privacy}","received_events_url":"https://api.github.com/users/NextDom/received_events","type":"Organization","site_admin":false },"private":false,"html_url":"https://github.com/NextDom/plugin-MiFlora","description":"plugin Jeedom pour gerer les Mi Flora","fork":false,"url":"https://api.github.com/repos/NextDom/plugin-MiFlora","forks_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/forks","keys_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/keys{/key_id}","collaborators_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/teams","hooks_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/hooks","issue_events_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/issues/events{/number}","events_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/events","assignees_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/assignees{/user}","branches_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/branches{/branch}","tags_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/tags","blobs_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/git/refs{/sha}","trees_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/git/trees{/sha}","statuses_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/statuses/{sha}","languages_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/languages","stargazers_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/stargazers","contributors_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/contributors","subscribers_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/subscribers","subscription_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/subscription","commits_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/commits{/sha}","git_commits_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/git/commits{/sha}","comments_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/comments{/number}","issue_comment_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/issues/comments{/number}","contents_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/contents/{+path}","compare_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/compare/{base}...{head}","merges_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/merges","archive_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/downloads","issues_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/issues{/number}","pulls_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/pulls{/number}","milestones_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/milestones{/number}","notifications_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/labels{/name}","releases_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/releases{/id}","deployments_url":"https://api.github.com/repos/NextDom/plugin-MiFlora/deployments","created_at":"2016-11-21T20:59:11Z","updated_at":"2018-05-07T19:26:18Z","pushed_at":"2018-05-12T08:12:20Z","git_url":"git://github.com/NextDom/plugin-MiFlora.git","ssh_url":"git@github.com:NextDom/plugin-MiFlora.git","clone_url":"https://github.com/NextDom/plugin-MiFlora.git","svn_url":"https://github.com/NextDom/plugin-MiFlora","homepage":null,"size":2699,"stargazers_count":2,"watchers_count":2,"language":"PHP","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":true,"forks_count":13,"mirror_url":null,"archived":false,"open_issues_count":7,"license":{ "key":"gpl-2.0","name":"GNU General Public License v2.0","spdx_id":"GPL-2.0","url":"https://api.github.com/licenses/gpl-2.0" },"forks":13,"open_issues":7,"watchers":2,"default_branch":"master" }, { "id":123343068,"name":"plugin-Optimize","full_name":"NextDom/plugin-Optimize","owner":{ "login":"NextDom","id":36200380,"avatar_url":"https://avatars2.githubusercontent.com/u/36200380?v=4","gravatar_id":"","url":"https://api.github.com/users/NextDom","html_url":"https://github.com/NextDom","followers_url":"https://api.github.com/users/NextDom/followers","following_url":"https://api.github.com/users/NextDom/following{/other_user}","gists_url":"https://api.github.com/users/NextDom/gists{/gist_id}","starred_url":"https://api.github.com/users/NextDom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/NextDom/subscriptions","organizations_url":"https://api.github.com/users/NextDom/orgs","repos_url":"https://api.github.com/users/NextDom/repos","events_url":"https://api.github.com/users/NextDom/events{/privacy}","received_events_url":"https://api.github.com/users/NextDom/received_events","type":"Organization","site_admin":false },"private":false,"html_url":"https://github.com/NextDom/plugin-Optimize","description":"Plugin pour Jeedom d\'optimisation des performances","fork":false,"url":"https://api.github.com/repos/NextDom/plugin-Optimize","forks_url":"https://api.github.com/repos/NextDom/plugin-Optimize/forks","keys_url":"https://api.github.com/repos/NextDom/plugin-Optimize/keys{/key_id}","collaborators_url":"https://api.github.com/repos/NextDom/plugin-Optimize/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/NextDom/plugin-Optimize/teams","hooks_url":"https://api.github.com/repos/NextDom/plugin-Optimize/hooks","issue_events_url":"https://api.github.com/repos/NextDom/plugin-Optimize/issues/events{/number}","events_url":"https://api.github.com/repos/NextDom/plugin-Optimize/events","assignees_url":"https://api.github.com/repos/NextDom/plugin-Optimize/assignees{/user}","branches_url":"https://api.github.com/repos/NextDom/plugin-Optimize/branches{/branch}","tags_url":"https://api.github.com/repos/NextDom/plugin-Optimize/tags","blobs_url":"https://api.github.com/repos/NextDom/plugin-Optimize/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/NextDom/plugin-Optimize/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/NextDom/plugin-Optimize/git/refs{/sha}","trees_url":"https://api.github.com/repos/NextDom/plugin-Optimize/git/trees{/sha}","statuses_url":"https://api.github.com/repos/NextDom/plugin-Optimize/statuses/{sha}","languages_url":"https://api.github.com/repos/NextDom/plugin-Optimize/languages","stargazers_url":"https://api.github.com/repos/NextDom/plugin-Optimize/stargazers","contributors_url":"https://api.github.com/repos/NextDom/plugin-Optimize/contributors","subscribers_url":"https://api.github.com/repos/NextDom/plugin-Optimize/subscribers","subscription_url":"https://api.github.com/repos/NextDom/plugin-Optimize/subscription","commits_url":"https://api.github.com/repos/NextDom/plugin-Optimize/commits{/sha}","git_commits_url":"https://api.github.com/repos/NextDom/plugin-Optimize/git/commits{/sha}","comments_url":"https://api.github.com/repos/NextDom/plugin-Optimize/comments{/number}","issue_comment_url":"https://api.github.com/repos/NextDom/plugin-Optimize/issues/comments{/number}","contents_url":"https://api.github.com/repos/NextDom/plugin-Optimize/contents/{+path}","compare_url":"https://api.github.com/repos/NextDom/plugin-Optimize/compare/{base}...{head}","merges_url":"https://api.github.com/repos/NextDom/plugin-Optimize/merges","archive_url":"https://api.github.com/repos/NextDom/plugin-Optimize/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/NextDom/plugin-Optimize/downloads","issues_url":"https://api.github.com/repos/NextDom/plugin-Optimize/issues{/number}","pulls_url":"https://api.github.com/repos/NextDom/plugin-Optimize/pulls{/number}","milestones_url":"https://api.github.com/repos/NextDom/plugin-Optimize/milestones{/number}","notifications_url":"https://api.github.com/repos/NextDom/plugin-Optimize/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/NextDom/plugin-Optimize/labels{/name}","releases_url":"https://api.github.com/repos/NextDom/plugin-Optimize/releases{/id}","deployments_url":"https://api.github.com/repos/NextDom/plugin-Optimize/deployments","created_at":"2018-02-28T21:11:55Z","updated_at":"2018-05-02T14:12:16Z","pushed_at":"2018-04-20T14:29:40Z","git_url":"git://github.com/NextDom/plugin-Optimize.git","ssh_url":"git@github.com:NextDom/plugin-Optimize.git","clone_url":"https://github.com/NextDom/plugin-Optimize.git","svn_url":"https://github.com/NextDom/plugin-Optimize","homepage":null,"size":2821,"stargazers_count":0,"watchers_count":0,"language":"PHP","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":true,"forks_count":3,"mirror_url":null,"archived":false,"open_issues_count":2,"license":{ "key":"gpl-2.0","name":"GNU General Public License v2.0","spdx_id":"GPL-2.0","url":"https://api.github.com/licenses/gpl-2.0" },"forks":3,"open_issues":2,"watchers":0,"default_branch":"master" }, { "id":124239286,"name":"extra-tools","full_name":"NextDom/extra-tools","owner":{ "login":"NextDom","id":36200380,"avatar_url":"https://avatars2.githubusercontent.com/u/36200380?v=4","gravatar_id":"","url":"https://api.github.com/users/NextDom","html_url":"https://github.com/NextDom","followers_url":"https://api.github.com/users/NextDom/followers","following_url":"https://api.github.com/users/NextDom/following{/other_user}","gists_url":"https://api.github.com/users/NextDom/gists{/gist_id}","starred_url":"https://api.github.com/users/NextDom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/NextDom/subscriptions","organizations_url":"https://api.github.com/users/NextDom/orgs","repos_url":"https://api.github.com/users/NextDom/repos","events_url":"https://api.github.com/users/NextDom/events{/privacy}","received_events_url":"https://api.github.com/users/NextDom/received_events","type":"Organization","site_admin":false },"private":false,"html_url":"https://github.com/NextDom/extra-tools","description":"Outils permettant la gÃ©nÃ©ration d\'un squellette de plugin Jeedom Ã  partir du plugin-Template","fork":false,"url":"https://api.github.com/repos/NextDom/extra-tools","forks_url":"https://api.github.com/repos/NextDom/extra-tools/forks","keys_url":"https://api.github.com/repos/NextDom/extra-tools/keys{/key_id}","collaborators_url":"https://api.github.com/repos/NextDom/extra-tools/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/NextDom/extra-tools/teams","hooks_url":"https://api.github.com/repos/NextDom/extra-tools/hooks","issue_events_url":"https://api.github.com/repos/NextDom/extra-tools/issues/events{/number}","events_url":"https://api.github.com/repos/NextDom/extra-tools/events","assignees_url":"https://api.github.com/repos/NextDom/extra-tools/assignees{/user}","branches_url":"https://api.github.com/repos/NextDom/extra-tools/branches{/branch}","tags_url":"https://api.github.com/repos/NextDom/extra-tools/tags","blobs_url":"https://api.github.com/repos/NextDom/extra-tools/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/NextDom/extra-tools/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/NextDom/extra-tools/git/refs{/sha}","trees_url":"https://api.github.com/repos/NextDom/extra-tools/git/trees{/sha}","statuses_url":"https://api.github.com/repos/NextDom/extra-tools/statuses/{sha}","languages_url":"https://api.github.com/repos/NextDom/extra-tools/languages","stargazers_url":"https://api.github.com/repos/NextDom/extra-tools/stargazers","contributors_url":"https://api.github.com/repos/NextDom/extra-tools/contributors","subscribers_url":"https://api.github.com/repos/NextDom/extra-tools/subscribers","subscription_url":"https://api.github.com/repos/NextDom/extra-tools/subscription","commits_url":"https://api.github.com/repos/NextDom/extra-tools/commits{/sha}","git_commits_url":"https://api.github.com/repos/NextDom/extra-tools/git/commits{/sha}","comments_url":"https://api.github.com/repos/NextDom/extra-tools/comments{/number}","issue_comment_url":"https://api.github.com/repos/NextDom/extra-tools/issues/comments{/number}","contents_url":"https://api.github.com/repos/NextDom/extra-tools/contents/{+path}","compare_url":"https://api.github.com/repos/NextDom/extra-tools/compare/{base}...{head}","merges_url":"https://api.github.com/repos/NextDom/extra-tools/merges","archive_url":"https://api.github.com/repos/NextDom/extra-tools/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/NextDom/extra-tools/downloads","issues_url":"https://api.github.com/repos/NextDom/extra-tools/issues{/number}","pulls_url":"https://api.github.com/repos/NextDom/extra-tools/pulls{/number}","milestones_url":"https://api.github.com/repos/NextDom/extra-tools/milestones{/number}","notifications_url":"https://api.github.com/repos/NextDom/extra-tools/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/NextDom/extra-tools/labels{/name}","releases_url":"https://api.github.com/repos/NextDom/extra-tools/releases{/id}","deployments_url":"https://api.github.com/repos/NextDom/extra-tools/deployments","created_at":"2018-03-07T13:22:49Z","updated_at":"2018-04-09T20:17:29Z","pushed_at":"2018-04-09T20:17:27Z","git_url":"git://github.com/NextDom/extra-tools.git","ssh_url":"git@github.com:NextDom/extra-tools.git","clone_url":"https://github.com/NextDom/extra-tools.git","svn_url":"https://github.com/NextDom/extra-tools","homepage":null,"size":119,"stargazers_count":0,"watchers_count":0,"language":"Python","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"forks_count":1,"mirror_url":null,"archived":false,"open_issues_count":5,"license":null,"forks":1,"open_issues":5,"watchers":0,"default_branch":"develop" }]';
        $updateTime = time();
        $this->dataStorage->storeRawData('repo_last_update_NextDom', $updateTime);
        $this->dataStorage->storeRawData('repo_data_NextDom', $repoData);
        $this->market->refresh();

        $result = $this->market->getItems();
        $this->assertTrue(is_array($result));
        $core = $this->getItemFromList($result, 'AlternativeMarket-Lists');
        $this->assertNull($core);
        $optimize = $this->getItemFromList($result, 'plugin-Optimize');
        $this->assertNotNull($optimize);
        $this->assertEquals('NextDom/plugin-Optimize', $optimize->getFullName());
        $this->assertFileExists('cache/NextDom_plugin-Optimize.png');
    }
}
